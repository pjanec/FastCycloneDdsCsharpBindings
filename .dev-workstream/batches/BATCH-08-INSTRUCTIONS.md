# BATCH-08: Managed View Unions + Marshaller Foundation (COMBINED)

**Batch Number:** BATCH-08  
**Tasks:** FCDC-010 completion (union managed views), FCDC-011 partial (marshaller foundation)  
**Phase:** Phase 2 - Code Generator  
**Estimated Effort:** 7-9 days  
**Priority:** CRITICAL  
**Dependencies:** BATCH-07 (Native types + Managed views for structs)

---

## üîÑ MANDATORY WORKFLOW: Test-Driven Task Progression

**CRITICAL: You MUST complete tasks in sequence with passing tests:**

1. **Task 1 (Union Managed Views):** Implement ‚Üí Write tests ‚Üí **ALL tests pass** ‚úÖ
2. **Task 2 (Marshaller Foundation):** Implement ‚Üí Write tests ‚Üí **ALL tests pass** ‚úÖ

**DO NOT** move to Task 2 until:
- ‚úÖ Task 1 implementation complete
- ‚úÖ Task 1 tests written
- ‚úÖ **ALL tests passing** (including previous 71 tests)

**Why:** Ensures each component solid before building on top. Prevents cascading failures.

---

## üìã Onboarding & Workflow

### Required Reading (IN ORDER)

1. **BATCH-07 Review:** `.dev-workstream/reviews/BATCH-07-REVIEW.md`
2. **Task Definitions:** `docs/FCDC-TASK-MASTER.md` ‚Üí FCDC-010, FCDC-011
3. **Design:** `docs/FCDC-DETAILED-DESIGN.md` ‚Üí ¬ß8.1 Three-Type Model, ¬ß6.4 Marshaller Interface
4. **Managed Views:** Review `Emitters/ManagedViewEmitter.cs` from BATCH-07

### Report Submission

When done: `.dev-workstream/reports/BATCH-08-REPORT.md`

---

## üéØ Objectives

**Part 1: Complete Managed Views (Unions)**
1. Implement union managed view with safe discriminator access
2. Implement safe arm accessor properties (CurrentArm pattern)
3. Handle default case arms

**Part 2: Marshaller Foundation**
4. Define IMarshaller<TManaged, TNative> interface
5. Implement struct marshaller code generation (primitives only)
6. Implement UTF-8 string encoding/decoding for FixedString
7. Wire marshaller generation into CodeGenerator

---

## ‚úÖ Tasks

### Task 1: Implement Union Managed Views

**File:** `tools/CycloneDDS.CodeGen/Emitters/ManagedViewEmitter.cs` (MODIFY)

Add method to generate managed views for unions:

```csharp
public string GenerateManagedUnion(TypeDeclarationSyntax type, string namespaceName)
{
    _sb.Clear();
    
    var typeName = type.Identifier.Text;
    var managedTypeName = $"{typeName}Managed";
    var nativeTypeName = $"{typeName}Native";
    
    // File header
    EmitLine("// <auto-generated/>");
    EmitLine($"// Generated managed view for union {typeName}");
    EmitLine();
    EmitLine("using System;");
    EmitLine();
    EmitLine($"namespace {namespaceName};");
    EmitLine();
    
    // Ref struct declaration
    EmitLine($"public ref struct {managedTypeName}");
    EmitLine("{");
    
    // Store reference to native
    EmitLine($"    private readonly ref {nativeTypeName} _native;");
    EmitLine();
    
    // Constructor
    EmitLine($"    internal {managedTypeName}(ref {nativeTypeName} native)");
    EmitLine("    {");
    EmitLine("        _native = ref native;");
    EmitLine("    }");
    EmitLine();
    
    // Discriminator property
    var discriminatorField = type.Members.OfType<FieldDeclarationSyntax>()
        .First(f => f.AttributeLists.SelectMany(al => al.Attributes)
            .Any(attr => attr.Name.ToString().Contains("Discriminator")));
    
    var discType = discriminatorField.Declaration.Type.ToString();
    var discName = discriminatorField.Declaration.Variables.First().Identifier.Text;
    
    EmitLine($"    public {discType} {discName} => _native.{discName};");
    EmitLine();
    
    // Safe accessor for each arm
    var caseFields = type.Members.OfType<FieldDeclarationSyntax>()
        .Where(f => f.AttributeLists.SelectMany(al => al.Attributes)
            .Any(attr => attr.Name.ToString().Contains("Case")));
    
    foreach (var caseField in caseFields)
    {
        var armType = caseField.Declaration.Type.ToString();
        var armName = caseField.Declaration.Variables.First().Identifier.Text;
        
        // Get case value from attribute
        var caseAttr = caseField.AttributeLists.SelectMany(al => al.Attributes)
            .First(attr => attr.Name.ToString().Contains("DdsCase"));
        var caseValue = caseAttr.ArgumentList?.Arguments.FirstOrDefault()?.ToString() ?? "0";
        
        EmitLine($"    public {armType}? Try{armName}()");
        EmitLine("    {");
        EmitLine($"        if (_native.{discName} == {caseValue})");
        EmitLine($"            return _native.{armName};");
        EmitLine("        return null;");
        EmitLine("    }");
        EmitLine();
    }
    
    EmitLine("}");
    
    return _sb.ToString();
}
```

---

### Task 2: Define IMarshaller Interface

**File:** `tools/CycloneDDS.CodeGen/Runtime/IMarshaller.cs` (NEW)

```csharp
namespace CycloneDDS.CodeGen.Runtime;

/// <summary>
/// Marshaller interface for converting between managed and native representations.
/// </summary>
public interface IMarshaller<TManaged, TNative> 
    where TNative : unmanaged
    where TManaged : struct
{
    /// <summary>
    /// Marshal managed data to native representation.
    /// </summary>
    void MarshalToNative(ref TManaged managed, ref TNative native);
    
    /// <summary>
    /// Unmarshal native data to managed representation.
    /// </summary>
    void UnmarshalFromNative(ref TNative native, ref TManaged managed);
}
```

---

### Task 3: Implement Marshaller Code Emitter

**File:** `tools/CycloneDDS.CodeGen/Emitters/MarshallerEmitter.cs` (NEW)

```csharp
using System.Text;
using Microsoft.CodeAnalysis.CSharp.Syntax;
using System.Linq;

namespace CycloneDDS.CodeGen.Emitters;

public class MarshallerEmitter
{
    private readonly StringBuilder _sb = new();
    
    public string GenerateStructMarshaller(TypeDeclarationSyntax type, string namespaceName)
    {
        _sb.Clear();
        
        var typeName = type.Identifier.Text;
        var marshallerName = $"{typeName}Marshaller";
        var managedTypeName = $"{typeName}Managed";
        var nativeTypeName = $"{typeName}Native";
        
        // File header
        EmitLine("// <auto-generated/>");
        EmitLine($"// Generated marshaller for {typeName}");
        EmitLine();
        EmitLine("using System;");
        EmitLine("using System.Text;");
        EmitLine("using CycloneDDS.CodeGen.Runtime;");
        EmitLine();
        EmitLine($"namespace {namespaceName};");
        EmitLine();
        
        // Class declaration
        EmitLine($"public class {marshallerName} : IMarshaller<{managedTypeName}, {nativeTypeName}>");
        EmitLine("{");
        
        // MarshalToNative
        EmitLine($"    public unsafe void MarshalToNative(ref {managedTypeName} managed, ref {nativeTypeName} native)");
        EmitLine("    {");
        
        var fields = type.Members.OfType<FieldDeclarationSyntax>().ToList();
        foreach (var field in fields)
        {
            EmitMarshalField(field, toNative: true);
        }
        
        EmitLine("    }");
        EmitLine();
        
        // UnmarshalFromNative
        EmitLine($"    public unsafe void UnmarshalFromNative(ref {nativeTypeName} native, ref {managedTypeName} managed)");
        EmitLine("    {");
        
        foreach (var field in fields)
        {
            EmitMarshalField(field, toNative: false);
        }
        
        EmitLine("    }");
        
        EmitLine("}");
        
        return _sb.ToString();
    }
    
    private void EmitMarshalField(FieldDeclarationSyntax field, bool toNative)
    {
        var fieldType = field.Declaration.Type.ToString();
        var fieldName = field.Declaration.Variables.First().Identifier.Text;
        
        // Primitives: direct copy
        if (IsPrimitive(fieldType))
        {
            if (toNative)
                EmitLine($"        native.{fieldName} = managed.{fieldName};");
            else
                EmitLine($"        managed.{fieldName} = native.{fieldName};");
            return;
        }
        
        // FixedString: UTF-8 encoding
        if (fieldType.StartsWith("FixedString"))
        {
            var size = fieldType switch {
                "FixedString32" => 32,
                "FixedString64" => 64,
                "FixedString128" => 128,
                _ => 32
            };
            
            if (toNative)
            {
                EmitLine($"        // Encode {fieldName} to UTF-8");
                EmitLine($"        fixed (byte* ptr = native.{fieldName})");
                EmitLine("        {");
                EmitLine($"            var span = new Span<byte>(ptr, {size});");
                EmitLine($"            var written = Encoding.UTF8.GetBytes(managed.{fieldName}, span);");
                EmitLine($"            if (written < {size}) span[written] = 0; // Null terminator");
                EmitLine("        }");
            }
            else
            {
                EmitLine($"        // Decode {fieldName} from UTF-8");
                EmitLine($"        fixed (byte* ptr = native.{fieldName})");
                EmitLine("        {");
                EmitLine($"            var span = new ReadOnlySpan<byte>(ptr, {size});");
                EmitLine("            var nullIndex = span.IndexOf((byte)0);");
                EmitLine("            if (nullIndex >= 0) span = span.Slice(0, nullIndex);");
                EmitLine($"            managed.{fieldName} = Encoding.UTF8.GetString(span);");
                EmitLine("        }");
            }
            return;
        }
        
        // TODO: Handle other types (DateTime, Guid, arrays, etc.)
        EmitLine($"        // TODO: Marshal {fieldName} ({fieldType})");
    }
    
    private bool IsPrimitive(string type)
    {
        return type is "byte" or "sbyte" or "short" or "ushort" or 
                       "int" or "uint" or "long" or "ulong" or 
                       "float" or "double" or "bool";
    }
    
    private void EmitLine(string text = "")
    {
        _sb.AppendLine(text);
    }
}
```

---

### Task 4: Integration into CodeGenerator

**File:** `tools/CycloneDDS.CodeGen/CodeGenerator.cs` (MODIFY)

Add marshaller generation after managed view generation:

```csharp
// After managed view generation...

// Generate Marshallers
var marshallerEmitter = new MarshallerEmitter();

foreach (var type in topicTypes)
{
    var marshallerCode = marshallerEmitter.GenerateStructMarshaller(type, namespaceName);
    var marshallerFile = Path.Combine(generatedDir, $"{type.Identifier.Text}Marshaller.g.cs");
    File.WriteAllText(marshallerFile, marshallerCode);
    Console.WriteLine($"[CodeGen]   Generated Marshaller: {marshallerFile}");
}
```

---

## üß™ Testing Requirements

### Minimum 15 Tests Required:

**Part 1: Union Managed View Tests (7 tests)**
1. ‚úÖ `UnionManagedView_IsRefStruct`
2. ‚úÖ `UnionManagedView_HasDiscriminatorProperty`
3. ‚úÖ `UnionManagedView_TryArm_ReturnsNullForWrongDiscriminator`
4. ‚úÖ `UnionManagedView_TryArm_ReturnsValueForCorrectDiscriminator`
5. ‚úÖ `UnionWithMultipleArms_AllHaveTryMethods`
6. ‚úÖ `UnionManagedView_CompilesWithoutErrors`
7. ‚úÖ `UnionManagedView_CanAccessNativeData` (runtime test)

**Part 2: Marshaller Tests (8 tests)**
8. ‚úÖ `Marshaller_ImplementsInterface`
9. ‚úÖ `Marshaller_PrimitiveFields_DirectCopy`
10. ‚úÖ `Marshaller_FixedString_EncodesUTF8`
11. ‚úÖ `Marshaller_FixedString_DecodesUTF8`
12. ‚úÖ `Marshaller_RoundTrip_PreservesData`
13. ‚úÖ `Marshaller_FixedString_TruncatesLongStrings`
14. ‚úÖ `Marshaller_FixedString_NullTerminated`
15. ‚úÖ `Marshaller_CompilesWithoutErrors`

### Example Test:

```csharp
[Fact]
public void UnionManagedView_TryArm_ReturnsValueForCorrectDiscriminator()
{
    var csCode = @"
[DdsUnion]
public partial class TestUnion {
    [DdsDiscriminator]
    public int D;
    [DdsCase(1)]
    public float Value;
}";
    
    var type = ParseType(csCode);
    var emitter = new ManagedViewEmitter();
    var code = emitter.GenerateManagedUnion(type, "Test");
    
    // Compile and test runtime behavior
    var assembly = CompileToAssembly(code + "\n" + GetNativeUnionCode());
    var nativeType = assembly.GetType("Test.TestUnionNative");
    var managedType = assembly.GetType("Test.TestUnionManaged");
    
    // Create native instance
    var native = Activator.CreateInstance(nativeType);
    nativeType.GetField("D").SetValue(native, 1);
    nativeType.GetField("Value").SetValue(native, 42.5f);
    
    // Create managed view
    var ctor = managedType.GetConstructor(new[] { nativeType.MakeByRefType() });
    var managed = ctor.Invoke(new[] { native });
    
    // Try accessor should return value
    var tryMethod = managedType.GetMethod("TryValue");
    var result = tryMethod.Invoke(managed, null);
    Assert.Equal(42.5f, (float?)result);
}
```

---

## üìä Report Requirements

### Required Sections

1. **Issues Encountered** (if any)
2. **Test Results** (86+ tests: 71 previous + 15 new)
3. **Developer Insights**

   **Q1:** What's the TryArm() pattern for unions and why is it safer than direct access?

   **Q2:** How does UTF-8 encoding handle strings longer than buffer size?

   **Q3:** What's the performance implication of encoding/decoding on every marshal?

   **Q4:** How would you handle nested structs in marshallers?

4. **Checklist**
   - [ ] Union managed views implemented
   - [ ] TryArm() methods for union arms
   - [ ] IMarshaller interface defined
   - [ ] Struct marshaller generation working
   - [ ] UTF-8 encoding/decoding for FixedString
   - [ ] Primitive field marshalling
   - [ ] 15+ tests passing
   - [ ] All 71 previous tests still passing

---

## üéØ Success Criteria

1. ‚úÖ Union managed views with safe discriminator checking
2. ‚úÖ TryArm() pattern implemented
3. ‚úÖ IMarshaller<TManaged, TNative> interface defined
4. ‚úÖ Struct marshaller code generation working
5. ‚úÖ UTF-8 encoding/decoding for FixedString
6. ‚úÖ Primitive fields marshal correctly
7. ‚úÖ Minimum 15 tests passing
8. ‚úÖ All 71 previous tests still passing (86 total)
9. ‚úÖ Report submitted

---

## ‚ö†Ô∏è Common Pitfalls

1. **Union discriminator checking** - TryArm() MUST check discriminator before accessing arm
2. **UTF-8 truncation** - Handle strings longer than buffer size gracefully
3. **Null termination** - FixedString buffers must be null-terminated
4. **Ref parameters** - Marshaller uses ref, not values
5. **Runtime tests** - Union managed views need actual runtime validation
6. **Encoding performance** - UTF-8 encode/decode happens on every marshal

---

## üìö Reference Materials

- **BATCH-07:** `.dev-workstream/reviews/BATCH-07-REVIEW.md`
- **Tasks:** `docs/FCDC-TASK-MASTER.md` (FCDC-010, FCDC-011)
- **Design:** `docs/FCDC-DETAILED-DESIGN.md` (¬ß8.1, ¬ß6.4)

---

**Focus: Complete managed views with union safety, start marshaller foundation with UTF-8 support.**
