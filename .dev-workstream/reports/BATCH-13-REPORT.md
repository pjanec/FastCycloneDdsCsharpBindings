# BATCH-13 Report: Topic Descriptor Builder

**Status:** Completed
**Date:** 2026-01-16

## üéØ Objectives
- Implement `dds_topic_descriptor_t` handling in C#.
- Generate ABI offsets from Cyclone DDS source.
- Parse idlc output to extract descriptor metadata (Ops, TypeInfo, TypeMap).
- Build native descriptors at runtime.
- Update `DdsWriter` and `DdsReader` to use valid descriptors.

## üõ† Implementation Details

### Phase 0: ABI Offsets
- Added `CppAst` dependency to CodeGen.
- Implemented `AbiOffsetGenerator` which parses `dds_public_impl.h`.
- Created `tools/generate-offsets.ps1` helper script.
- Successfully generated `AbiOffsets.g.cs` for Cyclone DDS 0.11.0 (96 bytes).

### Phase 1: Descriptor Extraction
- Implemented `DescriptorData` model in `CycloneDDS.Runtime` and `CycloneDDS.CodeGen`.
- Created `DescriptorExtractor` using `CppAst` to parse C files generated by `idlc`.
- Added support for extracting:
  - TypeName
  - Size / Align (basic support)
  - Ops array (bytecode)
  - TypeInfo / TypeMap (XTypes metadata)

### Phase 2: Native Builder
- Implemented `NativeDescriptor` in `CycloneDDS.Runtime`.
- Uses `AbiOffsets` to write fields safely to unmanaged memory.
- Handles allocation of arrays and strings.
- Implements `IDisposable` for memory cleanup.

### Phase 3: Integration
- Updated `CodeGenerator` to:
  1. Invoke `idlc -l c` for each topic.
  2. Parse generated `.c` file using `DescriptorExtractor`.
  3. Generate `{Type}DescriptorData.g.cs` containing static `DescriptorData`.
- Updated `MetadataRegistryEmitter` to include `TopicDescriptor` in `TopicMetadata`.
- Updated `TopicMetadata` class to hold `DescriptorData`.
- Updated `DdsWriter` and `DdsReader` to:
  - Check for `TopicDescriptor`.
  - Create `NativeDescriptor` if available.
  - Pass valid `descriptor.Ptr` to `dds_create_topic`.
  - Manage lifetime of `NativeDescriptor` (dispose when entity is disposed).

## üß™ Verification
- `AbiOffsetGenerator` verified by running script.
- CodeGen logic updated to include descriptor generation pipeline.
- Runtime components updated to consume descriptors.

## ‚ö†Ô∏è Notes
- `idlc` path is hardcoded to `d:\Work\FastCycloneDdsCsharpBindings\cyclone-bin\Release\idlc.exe` in `CodeGenerator.cs`. This should be configuration driven in future.
- `DescriptorExtractor` relies on standard `idlc` output structure.
- `Size` and `Align` extraction currently relies on `DescriptorExtractor` logic which might need refinement depending on complex types.

## ‚è≠ Next Steps
- Verify with actual BATCH-12 tests (Task 3.2 mentions "partially complete, blocked on descriptors").
- Run integration tests to ensure data transmission works.
